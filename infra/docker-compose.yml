services:
  gateway:
    build:
      context: ..
      dockerfile: services/gateway/Dockerfile
    env_file:
      - ../infra/env/gateway.env
    ports:
      - "8080:8080"
    depends_on:
      - auth
      - customer
      - office
      - accounts
      - ledger
      - fx
      - utilities
      - contracts
      - notifications
    networks:
      - banking

  auth:
    build:
      context: ..
      dockerfile: services/auth/Dockerfile
    env_file:
      - ../infra/env/auth.env
    depends_on:
      - auth_db
      - kafka
    networks:
      - banking

  customer:
    build:
      context: ..
      dockerfile: services/customer/Dockerfile
    env_file:
      - ../infra/env/customer.env
    depends_on:
      - customer_db
      - kafka
      - redis
    networks:
      - banking

  office:
    build:
      context: ..
      dockerfile: services/office/Dockerfile
    env_file:
      - ../infra/env/office.env
    depends_on:
      - office_db
      - kafka
    networks:
      - banking

  accounts:
    build:
      context: ..
      dockerfile: services/accounts/Dockerfile
    env_file:
      - ../infra/env/accounts.env
    depends_on:
      - accounts_db
      - kafka
    networks:
      - banking

  ledger:
    build:
      context: ..
      dockerfile: services/ledger/Dockerfile
    env_file:
      - ../infra/env/ledger.env
    depends_on:
      - ledger_db
      - kafka
    networks:
      - banking

  fx:
    build:
      context: ..
      dockerfile: services/fx/Dockerfile
    env_file:
      - ../infra/env/fx.env
    depends_on:
      - fx_db
      - redis
      - kafka
    networks:
      - banking

  utilities:
    build:
      context: ..
      dockerfile: services/utilities/Dockerfile
    env_file:
      - ../infra/env/utilities.env
    depends_on:
      - utilities_db
      - kafka
    networks:
      - banking

  contracts:
    build:
      context: ..
      dockerfile: services/contracts/Dockerfile
    env_file:
      - ../infra/env/contracts.env
    depends_on:
      - contracts_db
      - kafka
    networks:
      - banking

  notifications:
    build:
      context: ..
      dockerfile: services/notifications/Dockerfile
    env_file:
      - ../infra/env/notifications.env
    depends_on:
      - notifications_db
      - kafka
    networks:
      - banking

  frontend:
    build:
      context: ..
      dockerfile: frontend/Dockerfile
    env_file:
      - ../infra/env/frontend.env
    ports:
      - "3000:3000"
    depends_on:
      - gateway
    networks:
      - banking

  nginx:
    image: nginx:1.27-alpine
    volumes:
      - ../infra/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "80:80"
    depends_on:
      - frontend
      - gateway
    networks:
      - banking

  redis:
    image: redis:7-alpine
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    ports:
      - "6379:6379"
    networks:
      - banking

  kafka:
    image: bitnami/kafka:3.7
    environment:
      KAFKA_CFG_NODE_ID: 0
      KAFKA_CFG_PROCESS_ROLES: broker,controller
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 0@kafka:9093
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      ALLOW_PLAINTEXT_LISTENER: "yes"
    ports:
      - "9092:9092"
    networks:
      - banking

  splunk:
    image: splunk/splunk:9.2
    environment:
      SPLUNK_START_ARGS: "--accept-license"
      SPLUNK_PASSWORD: "changeme123"
    ports:
      - "8000:8000"
    networks:
      - banking

  kafka_connect:
    image: confluentinc/cp-kafka-connect:7.5.2
    environment:
      CONNECT_BOOTSTRAP_SERVERS: kafka:9092
      CONNECT_REST_PORT: 8083
      CONNECT_GROUP_ID: splunk-connect
      CONNECT_CONFIG_STORAGE_TOPIC: splunk-connect-config
      CONNECT_OFFSET_STORAGE_TOPIC: splunk-connect-offset
      CONNECT_STATUS_STORAGE_TOPIC: splunk-connect-status
      CONNECT_KEY_CONVERTER: org.apache.kafka.connect.storage.StringConverter
      CONNECT_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      CONNECT_INTERNAL_KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_INTERNAL_VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      CONNECT_PLUGIN_PATH: /usr/share/java
    depends_on:
      - kafka
    networks:
      - banking

  rediscommander:
    image: rediscommander/redis-commander:latest
    environment:
      REDIS_HOSTS: local:redis:6379
    ports:
      - "8081:8081"
    depends_on:
      - redis
    networks:
      - banking

  auth_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: auth
      POSTGRES_USER: banking
      POSTGRES_PASSWORD: banking
    ports:
      - "5433:5432"
    networks:
      - banking

  customer_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: customer
      POSTGRES_USER: banking
      POSTGRES_PASSWORD: banking
    networks:
      - banking

  office_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: office
      POSTGRES_USER: banking
      POSTGRES_PASSWORD: banking
    networks:
      - banking

  accounts_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: accounts
      POSTGRES_USER: banking
      POSTGRES_PASSWORD: banking
    networks:
      - banking

  ledger_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ledger
      POSTGRES_USER: banking
      POSTGRES_PASSWORD: banking
    networks:
      - banking

  fx_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: fx
      POSTGRES_USER: banking
      POSTGRES_PASSWORD: banking
    networks:
      - banking

  utilities_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: utilities
      POSTGRES_USER: banking
      POSTGRES_PASSWORD: banking
    networks:
      - banking

  contracts_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: contracts
      POSTGRES_USER: banking
      POSTGRES_PASSWORD: banking
    networks:
      - banking

  notifications_db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: notifications
      POSTGRES_USER: banking
      POSTGRES_PASSWORD: banking
    networks:
      - banking

networks:
  banking:
    driver: bridge
